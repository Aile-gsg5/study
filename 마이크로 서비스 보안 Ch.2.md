# 인가와 인증 기초
- 조직이 AWS에서 사용할 수 있는 가장 정확한 보안 통제인 인가와 인증을 조사
- 용어 정리
	- 권한 주체(principal): 클라우드 인프라 내의 개별 상호작용이나 요청을 시작하는 호출 엔터티. 조직 내부 또는 외부의 사용자이거나 서비스
	- 리소스(resource): 요청의 수신 측에는 데이터 저장소나 권한 주체가 상호작용하려는 서비스
	- 인가(Authorization(접근 통제(access control)))
		- 특정 리소스에 대한 접근을 정의하는 프로세스
		- 권한 주체의 신원, 대상 리소스, 요청을 보낸 환경 및 요청 위치 같은 요소를 고려하여 접근 요청 승인을 결정함
	- 인증(Authentication(신원 관리(identity management)))
		- 권한 주체가 자신을 식별하고 자신의 신원을 대상 시스템에 증명함으로서 다른 사람 행세를 하는 인원과 구별할 수 있는 메커니즘
- 인증과 인가는 함께 작동하여 잠재적인 위협을 방어하는 세부적인 통제를 제공함
- IAM(identity and Access Management)으로 불리는 신원과 접근 관리가 필요
	- 조직의 접근 정책에서 규정한 규칙을 지정하고 해당 규칙을 기반으로 수신한 요청을 평가해 요청 전송자의 접근을 허용할지 결정
## AWS IAM의 기초
- IAM은 접근 통제 및 인증의 중재자로서 마이크로서비스 아키텍처를 보호하는 데 중요한 역할을 함
- IAM은 글로벌 서비스이자 완전 관리형 서비스
	- 접근 통제 정책과 인증 로직을 클라우드 전반에 분산시키지 않아 접근 정책을 한 곳에서 중앙 집중화해 관리할 수 있음
	- AWS IAM에 정책을 생성하면 공동 책임 모델에 따라 AWS는 접근 정책을 시행할 책임이 있다
- 애플리케이션 내에서 어떤 사용자와 마이크로서비스가 서로 통신할 수 있는지 규정하는 보안 정책을 마련하는 것은 보안 전문가의 책임.
## AWS의 권한 주체
- IAM 사용자
	- 개인 자격증명으로 AWS에 로그인하는 일상적인 사용자
- 루트 사용자
	- 특별한 유형의 IAM 사용자로, AWS 계정에 대한 모든 제어가 가능한 슈퍼유저 권한을 가진 AWS 계정의 소유자
	- 루트 계정을 보호하고 일상적인 활동에 사용하지 않아야함
- IAM 그룹
	- 공통적인 권한 정책을 연결할 수 있는 사용자 집합
- IAM 역할
	- IAM 사용자와 매우 유사하며 개별 신원이 수행할 것으로 예상하는 작업이나 업무 기능 집합에 매핑
## IAM 정책
- AWS는 계정의 개별 권한 주체를 대상으로 접근 통제에 관한 권한을 JSON문서화하여 IAM 정책으로 접근을 통제한다
- 접근 통제 정책은 권한 주체와 리소스라는 2가지 유형의 행위자를 포함함
	- 권한 주체는 접근을 요청하는 행위자로, 행위자는 직원이거나 때로는 다른 클라우드 서비스
	- 리소스는 접근하려는 서비스로 데이터베이스, 아마존 S3 버킷 또는 AWS에서 제공하는 다른 클라우드 서비스
- 접근 통제 정책 방법
	- **권한 주체 기반 정책**(principal-based policies)/**신원 기반 정책**(identity-based policies): 개별 권한 주체가 클라우드 시스템 내에서 할 수 있는 작업을 제한함으로서 접근을 제한하는 방법
	- **리소스 기반 정책**(resource-based policies): 리소스에서 할 수 있는 작업을 요청 측 권한 주체에 따라 제한하는 방법
## 최소 권한의 원칙
- 알 필요성의 원칙(need to know)
	- 최소 권한의 원칙(PoLP, Principle of Least Privilege)을 적용하는 첫 번째 단계
		- 4가지 규칙
			- 1. 적절한 접근 권한 부여
			- 2. 올바른 개인에게만 부여
			- 3. 필요한 작업에 한해 수행
			- 4. 필요할 때만 부여
		- 최소 권한 원칙 준수하면 시스템의 한 영역 내 취약점이 다른 영역에 영향을 주지 않게 됨
## 최소 권한의 원칙과 폭발 반경
- 모듈화한 애플리케이션의 이점은 최소 권한의 원칙과 접근 통제를 구현해 실현할 수 있음
- 예를 들어 여러 비즈니스 로직이 동작하는 모놀리식 앱에서는 데이터베이스 3개를 전부 접근할 수 있는 권한이 있어야 하지만, 마이크로서비스 앱에서는 특정 데이터베이스로 접근할 수 있는 권한만 주면 된다
- 폭발 반경 최소화 가능
## AWS IAM 정책의 구조
- IAM 정책 내 모든 명령문의 목적은 조건(condition)이나 작업(action)에 부합하는 권한 주체(principal)의 접근을 허용하거나 차단할지를 명시하는 것
- 접근 정책 명령문의 구성 요소
	- Principal
		- 허가를 지시할 수 있는 대상을 나타내는 정책 요소. 정책 내 명시적으로 언급하거나 정책을 권한 주체에 연결하는 방법으로 처리 가능
	- Action
		- 허용하거나 거부할 작업을 나타내는 정책 요소. 데이터를 읽거나 테이블에 데이터를 쓰거나 또는 리소스가 처리할 수 있는 다른 작업을 지정
	- Resource
		- 명령문을 적용 가능한 리소스 또는 리소스 집합을 나타내는 정책 요소
	- Condition(선택 사항)
		- 명령문을 평가할 조건을 나타내는 정책 요소. action 정책 요소에 명시한 작업들을 effect 정책 요소대로 처리해도 될지를 평가하는 조건
	- Effect
		- 접근을 허용할지 거부할지 여부를 지시하는 정책 요소
- AWS의 모든 권한 주체와 리소스는 AWS에서 할당한 고유의 ARN(아마존 리소스 이름)으로 명확하게 식별 가능
- JSON 형식으로 IAM 정책 작성
## 권한 주체 기반 정책
- AWS 계정의 권한 주체에게 적용돼 해당 권한 주체의 접근 수준을 결정
- IAM은 default Deny 규칙을 따름
- 사용자/역할/그룹에 적용함
## 리소스 기반 정책
- 리소스 기반 정책을 지원하는 특정 리소스를 대상으로 적용
- 인라인 정책 전용으로 관리형 정책은 없음
- AWS 계정에 구속되지 않으므로 리소스를 소유한 AWS 계정이 아닌 모든 AWS 계정의 권한 주체를 포함할 수 있다
## 신뢰 영역
- 단일 계정 환경에서 리소스 기반 정책은 권한 주체 기반 정책 상위에서 부가적인 보호 계층을 적용할 수 있다.
## 정책 평가
- AWS는 요청을 평가한 다음 접근하려는 리소스나 서비스를 대상으로 한 요청을 허용할지 거부할지를 결정해야 한다
- 결정을 내릴 때 AWS는 표준 평가 알고리즘을 따른다
	- 1. Default로 모든 요청을 거부
	- 2. 해당하는 모든 정책과 명령문을 살펴보고 조건에 부합하는 겨웅 조건을 충족하는 명령문만 유지
	- 3. 정책 내에 요청을 명시적으로 거부하는 명령문이 있는 경우 요청을 거부. 명시적 거부 정책은 허용 정책보다 우선함
	- 4. 요청을 허용하는 정책이 있다면 요청을 다음 단계로 전달. 요청을 허용하는 신원 기반 정책이 없으면 요청을 거부하고 평가 종료
	- 5. 권한 주체가 대상 리소스와 동일한 계정에서 온 경우 요청이 신뢰 영역 내에서 온 것이라 가정할 수 있고 이럴 경우 리소스 기반 정책이 필요하지 않아 대상 리소스에 접근 허용
	- 6. 요청이 다른 계정의 권한 주체로부터 왔다면 리소스가 위치한 계정 내 요청을 허용하는 리소스 기반 정책이 필요하여 리소스 기반 정책 존재 유무 확인
## AWS IAM 정책의 고급 개념
- 마이크로서비스는 무수히 많은 권한 주체와 리소스를 갖고 있어 보안 정책 설계가 어려움
- AWS에서 제공하는 일부 고급 도구를 사용
### IAM 정책 조건
- AWS는 정책이 포함하고 있는 정책 및 명령문을 조건부 기준으로 평가할 수 있어 IAM 프로세스에 더 많은 유연성을 추가할 수 있음
- AWS는 수신한 요청에 대해 콘텍스트를 수집함
	- AWS에서 수행하려는 작업
	- 통신 대상의 리소스 이름과 ARN
	- 요청을 수행하는 권한 주체 또는 자격증명
	- 요청의 일부를 구성하는 요청자 IP 주소, 사용자 에이전트, 보안 전송 여부, 권한 주체가 다른 aWS 서비스인지 등 다양한 요소의 환경 데이터
	- 리소스 태그나 데이터베이스 테이블 등의 대상 리소스에 관한 추가 정보
- AWS 정책에서 지원하는 모든 조건 목록: https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_condition.html
### AWS 태그와 속성 기반 접근 통제
- AWS에서는 태그를 사용해 클라우드 리소스에 메타 데이터를 할당할 수 있다
	- 리소스를 관리하고 검색하며 필터링하는데 사용할 수 있는 키와 선택적 값으로 구성한 라벨
- 속성 기반 접근 통제(ABAC, Attribute-Basted Access Control): 조건부 정책에 따른 접근 통제 방법
	- Team X는 team: x 태그가 달린 리소스에 접근 가능
### Not 정책 요쇠 NotPrincipal 및 NotResource
- 제외 정책 요소
- 지정된 정책을 허용하지 않는 항목 목록을 명시하는데 사용
	- 예. 특정 사용자 외 모두 거부 정책, 특정 리소스 외 모두 거부 정책
## 역할 기반 접근 통제
- RBAC. Role-Based Access Control
- AWS 역할(role)은 보안 정책을 단순하고 확장 가능한 상태로 유지하면서 신원 생성을 단순화하는 것을 목표로 한다
- 역할은 특정 상황에서 사람들이 정의한 권한, 행동, 자격증명, 규범의 모음
- 현재 수행하는 역할에 따라 동일인에게 다른 제한을 두는 것이 가능
### 역할 기반 접근 통제 모델링
- 첫 단계는 다양한 리소스와 리소스에서 수행할 수 있게 인가된 작업을 식별하는 것
	- 1. 리소스에서 수행해야 하는 모든 작업을 나열해 기록
	- 2. 조직을 분석해 조직 내 직원과 해당 직원이 조직의 리소스별로 수행하는 작업을 식별
	- 3. 조직내 지원이 작업 수행에 사용할 개별 접근 패턴을 반영하도록 역할 생성
	- 4. 접근을 통제하는 IAM 정책을 역할에 할당 (최소 권한의 원칙 따르기)
	- 5. 개별 사용자에게 역할을 부여할 수 있지만 역할이 없는 모든 사용자의 리소스 직접 접근은 차단
![[Pasted image 20240519142904.png]]
- 역할을 통해 권한 제어
### 역할 보호
- 권한 주체가 역할을 맡을 수 있게 허용하는 것
- AWS 보안 토큰 서비스(STS, Security Token Service)를 사용해 모든 역할 전환 방법을 지원함
- 역할 전환을 할 권한 주체에게 STS에서 AssumeRole 작업을 호출할 수 있게 허용하는 IAM 정책을 연결해야 함
	- 이때 Resource에 Role을 지정
- IAM 역할에 IAM 역할 신뢰 정책(IAM role trust policy)라는 특수한 유형의 리소스 기반 정책을 연력할 수 있다
### 역할 수임
- 역할 수임은 AWS에서 향후 요청에 사용할 수 있는 임시 자격증명 모음을 요청하는 작업까지 포함
- 리소스에 접근하는데 사용하는 방법
	- 1. IAM은 역할 수임을 위해 STS 요청을 사용할 수 있게 허용된 사용자인지 확인
	- 2. 사용자는 특정 역할을 수임하고 임시 자격증명을 얻고자 AWS STS를 호출
	- 3. AWS STS는 IAM을 통해 대상 역할의 신뢰 정책에서 호출 측 권한 주체에게 역할 수임을 허용하는지 확인
	- 4. 호출 측 권한 주체는 자신의 자격증명 대신 수임을 희망하는 역할의 임시 자격증명을 사용해 리소스에 접근
- `aws sts get-caller-identity` 명령어를 이용하여 현재 신원 정보 확인 가능 (역할 수임 전이면 사용자, 역할 수임 이후면 역할을 보여줌)
	![[Pasted image 20240519144031.png]]
### AWS CLI를 사용한 역할 수임
`aws sts assume-role --role-arn arn:aws:iam::~~~ --role-session-name assumed-role-session`
- 임시 자격증명은 특정 날짜나 시간이 되면 만료되고 세션을 연결한다는 특성을 제외하면 일반 자격증명과 동일한 용도로 사용할 수 있다
### AWS 관리 콘솔을 사용한 역할 전환
![[Pasted image 20240519144445.png]]
![[Pasted image 20240519144543.png]]
### 서비스 연결 역할
- 서비스 연결 역할(Service-Linked Role)
	- AWS에서 미리 작성해둔 정책과 설명을 갖고 있고 역할 연결 대상 서비스는 서비스의 연결 역할에 사전에 정의한다
	- 다른 AWS 서비스를 호출하는 데 필요한 모든 권한을 포함한다
	- `aws iam create-service-linked-role --aws-service-name <service name>`명령어로 생성 가능
## 인증 및 신원 관리
- 신원의 기초
	- 자격(entitlements)
		- 작업 수행을 목적으로 사용자에게 부여한 권리나 특권을 의미
	- 속성(attributes)
		- 신원의 수명주기 내에서만 유효함
		- 관리자가 부여하거나 특정 작업을 수행해 얻을 수 있음
	- 특성(traits)
		- 주체의 고유한 특징으로 접근 통제 시스템이 접근 권한을 부여하는데 사용할 수 있는 사용자의 생물학적 특징이나 다른 신원 정보를 포함할 수 있음
- 정당한 사용자의 신원을 도용해 시스템에 접근하는 경우 신원이 손상됐다고 함
### 인증의 기초
- 신원의 무결성을 유지할 수 있다면 접근 통제 시스템은 해당 신원을 사용해 비인가 접근을 방지함
- 신원 손상을 방지하는 것이 인증 시스템의 주된 역할
- 인증은 전자적인 시스템에 제출한 사용자 신원에 대한 신뢰를 설정하는 프로세스
- 3가지 작업
	- 지식 기반 인증
		- AWS는 정당한 사용자만 알고 있는 지식을 증명하도록 사용자에게 요구 (비밀 번호, 비밀 핀 번호, 비밀 문구, 보안 질문 등)
	- 소유 기반 인증
		- 휴대폰, 유비키(Yubikey), 구글 타이탄 키(Titan key)등 물리적 하드웨어 인증 장치
	- 타사 인증
		- 액티브 디렉터리(Active Directory)나 조직에서 이미 신원을 등록하는 데 사용 중인 다른 메커니즘 등의 조직 내 시스템에 인증 작업을 위임
		- MFA 등
### AWS의 신원 연동
- AWS는 신원 서비스와 조직의 신원 관리 시스템을 통합할 수 있는 기능을 제공함
- 신원 연동(Identity federation): AWS가 인증 측면을 신뢰할 수 있는 서드파티 시스템에 위임하는 시스템
- 신원 공급자(IdP, Identity Provider): AWS를 대신해 신원을 실제 확인하는 서드파티 시스템
- 신원 연동의 흐름
	- 1. 외부 신원 관리 시스템과 AWS 계정 간에 일종의 신뢰 관계를 설정
	- 2. 리소스에 접근이 필요한 사용자는 온프레미스 시스템의 인증 프로세스를 먼저 통과할 필요가 있다
	- 3. 온프레미스 인증 시스템은 사용자의 신원을 검증했음을 AWS에서 확신할 수 있도록 보증할 수 있는 값(토큰)을 반환한다. AWS는 토큰으로 유효성 판단
	- 4. 사용자는 신뢰하기로 동의한 신원 공급자의 인증을 통과했을에 대한 증빙으로 토큰을 포함해 AWS에 요청 전송
	- 5. AWS는 토큰 또는 토큰의 어선셜(assertion)을 검증해 사용자가 실제로 신원 공급자의 검증을 통과했는지 확인
	- 6. 검증 과정을 통과하면 최종 사용자는 자신의 신원을 리소스에 접근 가능한 대상 AWS 계정의 역할로 교환 가능. 이 경우 외부 AWS 계정 사용자를 AWS에서 인증하는 것이 아니라 AWS에서 신뢰하는 서드파티 시스템에서 사용자를 인증하는 형태. 최종 사용자는 수임한 역할의 신원을 사용해 대상 리소스에 접근
### SAML 2.0과 OpenID Connect를 사용한 신원 연동
- SAML(Security Assertion Markup Language) 2.0
	- 보안 도메인 간 신원을 교환하는 데 사용하는 가장 일반적인 표준
	- 많은 서드파티 신원 공급자가 SAML 2.0을 완벽히 준수하고 있어 연동 가능
- OIDC(OpenID Connect)
	- AWS 계정에 신뢰할 수 있는 신원 공급자를 추가하는 데 사용할 수 있는 또 다른 도구
	- OAuth 2.0 기반으로 개발되었으며 AWS가 최종 사용자의 신원을 HTTP 프로토콜 기반으로 확인할 수 있게 해줌
	- SAML과 마찬가지로 통합 사용자가 역할 수임 목적으로 자신의 외부 신원을 AWS 계정의 역할로 교환할 수 있게 해줌
- AWS에서 이미 사용 중인 신원 공급자를 대상으로 인증 위임을 허용하기 때문에 직원이 추적 및 관리해야 할 로그인 자격증명의 수를 줄이는 효과가 있음
## 역할 기반 접근 통제와 마이크로서비스
- 마이크로서비스 간 서로 상호작용 하는 경우가 많아 자칫 잘못하면 IAM 정책이 복잡해질 수 있음
- 마이크로서비스 앱의 복잡성을 유지하면서 접근 통제를 구현하는데 도움을 줄 수 있는 클라우드 인프라 아키텍처 요소 몇 가지를 살펴보자
### 실행 역할
- 역할 기반 접근 통제를 지원하는 많은 AWS 서비스는 실행 역할(execution role)로 불리는 특정 default 역할을 위임받아 서비스 실행함
- 마이크로서비스를 싱행하는 애플리케이션이 비밀번호가 아닌 역할을 사용해 클라우드 리소스에 접근하는 것이 모범 사례
### AWS 람다를 사용한 역할 기반 접근 통제
- 람다 함수 생성 시점에 실행 역할을 지정할 수 있음
- 개별 람다 함수에 역할이 연결되어 최소 권한의 원칙을 위반하지 않는 명확한 접근 통제 로직을 갖고 AWS 람다에서 실행되는 저넻 마이크로서비스 애플리케이션을 쉽게 설계
### EC2와 인스턴스 메타데이터 서비스로 역할 기반 접근 통제
- 인스턴스 메타데이터 서비스(IMDS, Instance MetaData Service)라는 약간 수정된 버전의 AWS 람다 실행 역할을 사용할 수 있음
	- 앱은 IMDS를 통해 액세스키와 ID 등의 정보에 접근 가능
- EC2 인스턴스에 역할을 연결할 수 있음
- 애플리케이션은 신원에 대한 정보를 모르지만 IMDS에 질의해 신원을 확인하여 임시 자격증명을 사용해 리소스에 요청 가능
- `http://169.254.169.254/latest` HTTP curl 요청을 전송하여 IMDS 질의 가능
### 서비스 계정이 필요로 하는 IAM 역할을 사용하는 아마존 EKS로 역할 기반 접근 통제
- 노드의 기본 IAM 역할은 개별 마이크로서비스에서도 유효하여 안전하지 않은 방법임
- 쿠버네티스는 시스템 상 2가지 신원 집합을 사용함
	- RoleBindings: 파드나 사용자 접근을 허용함
	- IAM 역할: 클라우드 리소스에 대한 접근을 통제함
- AWS가 제공한 신원 관리 방안은 k8s Service Account 어노테이션 및 OIDC 자격증명 공급자를 사용하여 AWS람다와 동일한 방식으로 개별 파드에 IAM 역할을 할당하고 사용
- 접근 과정
	- 1. EKS가 뮤테이팅 웹훅(mutating webhook)기능을 사용해 추가한 정보로 파드를 변경함으로서 개별 파드는 조직 내 역할을 STS에서 교환하는데 사용할 토큰을 포함하는 서비스 계정 정보를 annotation에 작성. 2단계에서 OIDC 신원 공급자가 파드를 식별하는데 사용할 Web ID token 파일도 삽입
	- 2. 파드는 자격증명을 갖고 오기 위해 1에서 획득한 서비스 계정 토큰을 사용해 역할 수임을 STS에 요청. 해당 토큰은 AWS 임시 인증 자격증명을 얻기 위함
	- 3. STS는 OIDC 신원 공급자에게 파드이 요청이 유효한지 검증 요청
	- 4. OIDC 신원 공급자는 긍정적인 응답 전송
	- 5. STS는 파드가 희망하는 역할을 사용해 AWS 리소스에 접근하는데 사용할 수 있는 임시 자격증명을 응답
	- 6. 파드는 STS에서 제공한 임시 자격증명을 이용해 AWS 리소스에 접근
## 요약
- 인가와 인증은 보안 아키텍트가 보안 시스템 위험의 합을 줄이고자 취할 수 있는 가장 중요한 통제 기능으로 인가와 인증을 잘 이해하면 보다 나은 시스템을 설계하는데 도움을 준다